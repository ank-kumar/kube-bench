---
controls:
version: 1.6
id: 1
text: "Master Node Security Configuration"
type: "master"
groups:
- id: 1.1
  text: "API Server"
  checks:
  - id: 1.1.1
    text: "Ensure that the --anonymous-auth argument is set to false (Scored)"
    type: "skip"
    scored: true

  - id: 1.1.2
    text: "Ensure that the --basic-auth-file argument is not set (Scored)"
    audit: "grep -A2 basic-auth-file /etc/origin/master/master-config.yaml"
    tests:
      test_items:
      - flag: "--basic-auth-file"
        compare:
          op: eq
          value: ""
        set: false
    remediation: |
      Edit the kubernetes master config file /etc/origin/master/master-config.yaml and
      remove the basic-auth-file entry.

      kubernetesMasterConfig:
        apiServerArguments:
           basic-auth-file:
             - /path/to/any/file
    scored: true

  - id: 1.1.3
    text: "Ensure that the --insecure-allow-any-token argument is not set (Scored)"
    type: "skip"
    scored: true

  - id: 1.1.4
    text: "Ensure that the --kubelet-https argument is set to true (Scored)"
    audit: "grep -A4 kubeletClientInfo /etc/origin/master/master-config.yaml"
    tests:
      bin_op: and
      test_items:
      - flag: "kubeletClientInfo:"
        compare:
          op: eq
          value: "kubeletClientInfo:"
        set: true
      - flag: "ca: ca-bundle.crt"
        compare:
          op: eq
          value: "ca-bundle.crt"
        set: true
      - flag: "certFile: master.kubelet-client.crt"
        compare:
          op: eq
          value: "certFile: master.kubelet-client.crt"
        set: true
      - flag: "keyFile: master.kubelet-client.key"
        compare:
          op: eq
          value: "keyFile: master.kubelet-client.key"
        set: true
      - flag: "port: 10250"
        compare:
          op: eq
          value: "port: 10250"
        set: true
    remediation: |
      Edit the kubernetes master config file /etc/origin/master/master-config.yaml
      and change it to match the below.

      kubeletClientInfo:
        ca: ca-bundle.crt
        certFile: master.kubelet-client.crt
        keyFile: master.kubelet-client.key
        port: 10250
    scored: true

  - id: 1.1.5
    text: "Ensure that the --insecure-bind-address argument is not set (Scored)"
    audit: "grep -A2 insecure-bind-address /etc/origin/master/master-config.yaml"
    tests:
      test_items:
      - flag: "insecure-bind-address"
        set: false
    remediation: |
      Edit the kubernetes master config file /etc/origin/master/master-config.yaml
      and remove the insecure-bind-address entry.

      kubernetesMasterConfig:
        apiServerArguments:
           insecure-bind-address:
           - 127.0.0.1
    scored: true

  - id: 1.1.6
    text: "Ensure that the --insecure-port argument is set to 0 (Scored)"
    audit: "grep -A2 insecure-port /etc/origin/master/master-config.yaml"
    tests:
      test_items:
      - flag: "insecure-port"
        set: false
    remediation: |
     Edit the kubernetes master config file /etc/origin/master/master-config.yaml
     and remove the insecure-port entry.

     kubernetesMasterConfig:
       apiServerArguments:
         insecure-port:
         - 0
    scored: true

  - id: 1.1.7
    text: "Ensure that the --secure-port argument is not set to 0 (Scored)"
    audit: "grep -A2 secure-port /etc/origin/master/master-config.yaml"
    tests:
      bin_op: or
      test_items:
      - flag: "secure-port"
        set: false
      - flag: "secure-port"
        compare:
          op: nothave
          value: "0"
        set: true
    remediation: |
     Edit the kubernetes master config file /etc/origin/master/master-config.yaml
     and either remove the secure-port parameter or set it to a different (non-zero)
     desired port.

     kubernetesMasterConfig:
       apiServerArguments:
         secure-port:
         - 8443
    scored: true

  - id: 1.1.8
    text: "Ensure that the --profiling argument is set to false (Scored)"
    type: "skip"
    scored: true

  - id: 1.1.9
    text: "Ensure that the --repair-malformed-updates argument is set to false (Scored)"
    audit: "grep -A2 repair-malformed-updates /etc/origin/master/master-config.yaml"
    tests:
      bin_op: or
      test_items:
      - flag: "repair-malformed-updates"
        set: false
      - flag: "repair-malformed-updates"
        compare:
          op: have
          value: "true"
        set: true
    remediation: |
     Edit the kubernetes master config file /etc/origin/master/master-config.yaml
     and remove the repair-malformed-updates entry or set repair-malformed-updates=true.
    scored: true

  - id: 1.1.10
    text: "Ensure that the admission control plugin AlwaysAdmit is not set (Scored)"
    audit: "grep -A4 AlwaysAdmit /etc/origin/master/master-config.yaml"
    tests:
      test_items:
      - flag: "AlwaysAdmit"
        set: false
    remediation: |
      Edit the kubernetes master config file /etc/origin/master/master-config.yaml
      and remove the the entry below.

      AlwaysAdmit:
        configuration:
          kind: DefaultAdmissionConfig
          apiVersion: v1
          disable: false
    scored: true

  - id: 1.1.11
    text: "Ensure that the admission control plugin AlwaysPullImages is set (Scored)"
    audit: "grep -A4 AlwaysPullImages /etc/origin/master/master-config.yaml"
    tests:
      bin_ops: and
      test_items:
      - flag: "AlwaysPullImages"
        compare:
          op: has
          value: "AlwaysPullImages"
        set: true
      - flag: "disable"
        compare:
          op: has
          value: "false"
    remediation: |
      Edit the kubernetes master config file /etc/origin/master/master-config.yaml
      and add the the entry below.

      admissionConfig:
        pluginConfig:
          AlwaysPullImages:
            configuration:
              kind: DefaultAdmissionConfig
              apiVersion: v1
              disable: false
    scored: true

  - id: 1.1.12
    text: "Ensure that the admission control plugin DenyEscalatingExec is set (Scored)"
    type: "skip"
    scored: true

  - id: 1.1.13
    text: "Ensure that the admission control plugin SecurityContextDeny is set (Scored)"
    type: "skip"
    scored: true

  - id: 1.1.14
    text: "Ensure that the admission control plugin NamespaceLifecycle is set (Scored)"
    audit: "grep -A4 NamespaceLifecycle $apiserverconf"
    tests:
      test_items:
      - flag: "NamespaceLifecycle"
        set: false
    remediation: |
      Edit the kubernetes master config file $apiserverconf
      and remove the following entry.

      NamespaceLifecycle: 
        configuration:
          kind: DefaultAdmissionConfig
          apiVersion: v1
          disable: true
    scored: true

  - id: 1.1.15
    text: "Ensure that the --audit-log-path argument is set as appropriate (Scored)"
    audit: "grep -A5 auditConfig $apiserverconf"
    tests:
      bin_op: and
      test_items:
      - flag: "auditConfig"
        compare:
          op: has
          value: "auditConfig"
        set: true
      - flag: "enabled: true"
        compare:
          op: eq
          value: "enabled: true"
        set: true
    remediation: |
      Edit the Openshift master config file $apiserverconf, update the following entry and restart the API server.

      auditConfig:
        auditFilePath: "/var/log/audit-ocp.log"
        enabled: true
        maximumFileRetentionDays: 10
        maximumFileSizeMegabytes: 10
        maximumRetainedFiles: 10

      Make the same changes in the inventory/ansible variables so the changes are not
      lost when an upgrade occurs.
    scored: true

  - id: 1.1.16
    text: "Ensure that the --audit-log-maxage argument is set to 30 or as appropriate (Scored)"
    audit: "grep -A5 auditConfig $apiserverconf"
    tests:
      bin_op: and
      test_items:
      - flag: "auditConfig"
        compare:
          op: has
          value: "auditConfig"
        set: true
      - flag: "maximumFileRetentionDays"
        compare:
          op: has
          value: "maximumFileRetentionDays"
        set: true
    remediation: |
      Edit the Openshift master config file $apiserverconf,
      update the maximumFileRetentionDays entry and restart the API server.

      auditConfig:
        auditFilePath: "/var/log/audit-ocp.log"
        enabled: true
        maximumFileRetentionDays: 10
        maximumFileSizeMegabytes: 10
        maximumRetainedFiles: 10

      Make the same changes in the inventory/ansible variables so the changes are not
      lost when an upgrade occurs.
    scored: true

  - id: 1.1.17
    text: "Ensure that the --audit-log-maxbackup argument is set to 10 or as appropriate (Scored)"
    audit: "grep -A5 auditConfig $apiserverconf"
    tests:
      bin_op: and
      test_items:
      - flag: "auditConfig"
        compare:
          op: has
          value: "auditConfig"
        set: true
      - flag: "maximumFileRetentionDays"
        compare:
          op: has
          value: "maximumFileRetentionDays"
        set: true
    remediation: |
      Edit the Openshift master config file $apiserverconf,
      update the maximumFileRetentionDays entry and restart the API server.

      auditConfig:
        auditFilePath: "/var/log/audit-ocp.log"
        enabled: true
        maximumFileRetentionDays: 10
        maximumFileSizeMegabytes: 10
        maximumRetainedFiles: 10

      Make the same changes in the inventory/ansible variables so the changes are not
      lost when an upgrade occurs.
    scored: true

  - id: 1.1.23
    text: "Ensure that the --service-account-lookup argument is set to true (Scored)"
    type: "skip"
    scored: true

  - id: 1.1.24
    text: "Ensure that the admission control plugin PodSecurityPolicy is set (Scored)"
    type: "skip"
    scored: true

  - id: 1.1.31
    text: "Ensure that the --etcd-cafile argument is set as appropriate (Scored)"
    type: "skip"
    scored: true

